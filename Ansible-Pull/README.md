# Roles // Ansible-Pull

This role establishes an ansible pull method on a given host.  This decentralized the process and removes the immediate need for a control server.  While each host can pull and run the playbooks needed, there is no inherent centralized tracking if multiple systems are using this method.  Each host is independently responsible for updating and running the playbook(s) needed.  

## OS Family / Distrobution
* RHEL
  * RHEL 7
  * RHEL 8
  * Fedora 37
* Debian
  * Ubuntu 22.04

## Requirements

This role assumes that python with the ansible library, and git are installed on the target system.  While most Linux-based systems may already have a version of python installed, the ansible library may need to be installed via pip or the distribution's package manager.  

Additionally, a password file is used for encrypted vars.  This file is not generated by the playbook and needs to be deployed to the target system.  

## Role Variables

The vars used in this role are defined in var/user.yml.  These defined the maintenance user that will be responsible for executing the ansible playbook.  The var 'home' is used to define both the home folder for that maintenance user and the root working path for the ansible-pull tasks.  Some vars are encrypted via ansible-vault and the use of a password file is used to decrypt them on the target system.  

## Dependencies

This role only utilizes of the ansible.builtin library. 

## Examples

### Playbook

```yaml
---

- name: "Ansible playbook for the pulling configs from git."
  hosts: localhost
  connection: local
  gather_facts: true
  become: true

  roles:
    - Ansible-Pull

```
### Bash Script 
This script can be used as part of a kickstart file or separately to start the process.
```bash
#!/bin/bash
set -eux 

# These vars should match the roles var/user.yml file.
username='sysconfmgr'
comment='System Configuration Manager'
home='/opt/ansible'
#vaultpasswd=''

# RHEL
dnf -y install python3 python3-pip git
# Debian 
# apt -y install python3 python3-pip git 

/usr/sbin/useradd --comment "${comment}" \
  --home-dir "${home}" \
  --create-home \
  --system \
  --shell "/bin/bash" \
  ${username}

/usr/bin/echo "${username} ALL=(root) NOPASSWD:ALL" | /usr/bin/tee -a /etc/sudoers.d/00-ansible
/usr/bin/chmod 0440 /etc/sudoers.d/00-ansible

# Now assume the maintenance user, setup ansible, and run the playbook. 
su - ${username} << EOF

python3 -m pip install ansible

/usr/bin/mkdir ${home}/logs

# The valut password needs to be shared with this host.  
# You can uncomment the following line, and var above.  
# However, the password will be stored unencypted within this script. 
printf "${vaultpasswd}" >> "${home}/.vault_pass" 

/opt/ansible/.local/bin/ansible-pull \
  -vvv \
  --diff \
  --vault-password-file=/opt/ansible/.vault_pass \
  --url https://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:x-oauth-basic@github.com/patriotmercenary/ansible_lab.git \
  local.yml >> ${home}/logs/cron.log 2>&1

EOF
```

## License

GNU General Public License version 3

## Author Information

Initially written by Ron Jones Jr.  
Additional contributors should be tracked and credited via Git comments. 